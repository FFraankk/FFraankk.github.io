<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浏览器端二维码解析器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        #drop-zone {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        #preview {
            max-width: 300px;
            max-height: 300px;
            margin: 20px auto;
            display: none;
        }
        #result {
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            word-break: break-all;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>浏览器端二维码解析器</h1>
    
    <div id="drop-zone">
        <p>拖放图片至此 或 点击选择文件</p>
        <input type="file" id="file-input" accept="image/*">
    </div>

    <img id="preview" alt="图片预览">
    
    <div id="result" class="hidden"></div>

    <!-- 使用 jsQR 库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // 文件选择处理
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');
        const resultDiv = document.getElementById('result');

        // 处理文件选择
        async function handleFile(file) {
            try {
                const imageData = await loadImage(file);
                const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (qrCode) {
                    showResult(`解码成功：<br>${qrCode.data}`);
                } else {
                    showResult("未检测到二维码", true);
                }
            } catch (error) {
                showResult(`解析失败：${error.message}`, true);
            }
        }

        // 加载图片到Canvas
        async function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 限制最大尺寸
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxSize || height > maxSize) {
                            const ratio = Math.min(maxSize/width, maxSize/height);
                            width = width * ratio;
                            height = height * ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(ctx.getImageData(0, 0, width, height));
                    };
                    img.src = e.target.result;
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        }

        // 显示结果
        function showResult(text, isError = false) {
            resultDiv.innerHTML = text;
            resultDiv.className = isError ? 'error' : '';
            resultDiv.classList.remove('hidden');
        }

        // 事件监听
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#666';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
    </script>
</body>
</html>
